{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶ˆë²•ì£¼ì°¨ í†µê³„</title>
    <style>
        /* CSS ë³€ìˆ˜ ì •ì˜ - ì „ì—­ ìƒ‰ìƒ ë° ìŠ¤íƒ€ì¼ ë³€ìˆ˜ */
        :root {
            --bg: #b0c3cf;                      /* ë°°ê²½ìƒ‰ */
            --card: #1a1f29;                    /* ì¹´ë“œ ë°°ê²½ìƒ‰ */
            --muted: #9ca3af;                   /* íë¦° í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            --text: #f7f7f7;                    /* ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            --primary: #4f9cff;                 /* ì£¼ìš” ìƒ‰ìƒ */
            --primary-strong: #3b82f6;          /* ì§„í•œ ì£¼ìš” ìƒ‰ìƒ */
            --accent: #38e1b8;                  /* ê°•ì¡° ìƒ‰ìƒ */
            --success: #22c55e;                 /* ì„±ê³µ ìƒ‰ìƒ */
            --warning: #f59e0b;                 /* ê²½ê³  ìƒ‰ìƒ */
            --danger: #ef4444;                  /* ìœ„í—˜ ìƒ‰ìƒ */
            --line: rgba(255, 255, 255, 0.08);  /* í…Œë‘ë¦¬ ìƒ‰ìƒ */
            --chip: rgba(79, 156, 255, 0.1);    /* ì¹© ë°°ê²½ìƒ‰ */
            --chip-line: rgba(79, 156, 255, 0.4); /* ì¹© í…Œë‘ë¦¬ ìƒ‰ìƒ */
            --radius: 14px;                     /* ê¸°ë³¸ ëª¨ì„œë¦¬ ë‘¥ê¸€ê¸° */
            --radius-sm: 10px;                  /* ì‘ì€ ëª¨ì„œë¦¬ ë‘¥ê¸€ê¸° */
            --shadow: 10px 8px 30px rgba(0, 0, 0, 0.5); /* ê·¸ë¦¼ì íš¨ê³¼ */
            --glass: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02)); /* ìœ ë¦¬ íš¨ê³¼ */
        }

        /* ì „ì²´ í˜ì´ì§€ ì„¤ì • */
        html, body { height: 100%; }
        body {
            transform: scale(0.9);              /* ì „ì²´ í¬ê¸° 90%ë¡œ ì¶•ì†Œ */
            transform-origin: top center;       /* ì¶•ì†Œ ê¸°ì¤€ì : ìƒë‹¨ ì¤‘ì•™ */
            background-repeat: repeat;
            background-size: cover;
            background-attachment: fixed;
            margin: 0;
            /* ë°°ê²½ ê·¸ë¼ë””ì–¸íŠ¸ íš¨ê³¼ */
            background:
                radial-gradient(1200px 800px at 10% -10%, rgba(56, 225, 184, 0.12), transparent 45%),
                radial-gradient(1000px 800px at 110% 10%, rgba(79, 156, 255, 0.12), transparent 40%),
                var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .wrap { max-width: 1400px; margin: 0 auto; padding: 26px; }
        a { color: inherit; text-decoration: none; }

        /* ìƒë‹¨ í—¤ë”ë°” */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        /* í—¤ë” ì™¼ìª½ ì˜ì—­ */
        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        .back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid var(--line);
            border-radius: 10px;
            color: var(--text);
            text-decoration: none;
            background: var(--glass);
            backdrop-filter: blur(8px);         /* ë°°ê²½ ë¸”ëŸ¬ íš¨ê³¼ */
            transition: all 0.18s ease;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3);
        }
        .back:hover { transform: translateY(-1px); border-color: var(--chip-line); }

        /* í˜ì´ì§€ ì œëª© */
        .title {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.2px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); /* í…ìŠ¤íŠ¸ ê·¸ë¦¼ì */
        }

        /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--chip-line);
            background: var(--chip);
            color: var(--primary);
        }

        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ì»¨íŠ¸ë¡¤ ê·¸ë£¹ (ë¼ë²¨ + ì…€ë ‰íŠ¸ë°•ìŠ¤) */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* ì»¨íŠ¸ë¡¤ ë¼ë²¨ */
        .control-group label {
            font-size: 12px;
            color: var(--text);
            font-weight: 700;
            letter-spacing: 0.3px;
            text-transform: uppercase;          /* ëŒ€ë¬¸ì ë³€í™˜ */
        }

        /* ì…€ë ‰íŠ¸ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .control-group select {
            padding: 8px 12px;
            border: 1px solid var(--chip-line);
            border-radius: var(--radius-sm);
            background: linear-gradient(180deg, rgba(26, 31, 41, 0.95), rgba(26, 31, 41, 0.85));
            backdrop-filter: blur(8px);
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.18s ease;
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* ì…€ë ‰íŠ¸ë°•ìŠ¤ í¬ì»¤ìŠ¤ ìƒíƒœ */
        .control-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 156, 255, 0.2), 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* ì…€ë ‰íŠ¸ë°•ìŠ¤ ì˜µì…˜ */
        .control-group select option {
            background: var(--card);
            color: var(--text);
            padding: 8px;
        }

        /* ë©”ì¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (2ì—´) */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;     /* ì™¼ìª½: 2, ì˜¤ë¥¸ìª½: 1 ë¹„ìœ¨ */
            gap: 30px;
            height: calc(100vh - 160px);        /* í™”ë©´ ë†’ì´ì—ì„œ ìƒë‹¨ë°” ë†’ì´ ì œì™¸ */
        }

        /* ì™¼ìª½ ì»¬ëŸ¼ */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* ì˜¤ë¥¸ìª½ ì»¬ëŸ¼ */
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* ê° ì„¹ì…˜ë³„ ê³ ì • ë†’ì´ ì„¤ì • */
        .summary-section {
            height: 140px;                      /* í†µê³„ ìš”ì•½ ì„¹ì…˜ ë†’ì´ */
            flex-shrink: 0;                     /* ì¶•ì†Œ ë°©ì§€ */
        }

        .map-section {
            height: 675px;                      /* ì§€ë„ ì„¹ì…˜ ë†’ì´ */
            flex-shrink: 0;
        }

        .pie-section {
            height: 300px;                      /* íŒŒì´ì°¨íŠ¸ ì„¹ì…˜ ë†’ì´ */
            flex-shrink: 0;
        }

        .tabs-section {
            height: 570px;                      /* íƒ­ ì„¹ì…˜ ë†’ì´ */
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card {
            background: linear-gradient(180deg, rgba(26, 31, 41, 0.95), rgba(26, 31, 41, 0.9));
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            height: 100%;
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        /* ê° ì„¹ì…˜ë³„ ì¹´ë“œ ë§ˆì§„ ì¡°ì • */
        .summary-section .card { margin-bottom: 20px; }
        .map-section .card { position: relative; margin-top: 20px; }
        .pie-section .card { margin-bottom: 20px; }
        .tabs-section { margin-top: 20px; }

        /* ì¹´ë“œ ì œëª© */
        .card h2 {
            margin: 0 0 16px;
            font-size: 16px;
            font-weight: 800;
            color: #cbd5e1;
            letter-spacing: 0.2px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        /* í†µê³„ ìš”ì•½ ê·¸ë¦¬ë“œ */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3ê°œ ì»¬ëŸ¼ìœ¼ë¡œ ê· ë“± ë¶„í•  */
            gap: 12px;
        }

        /* ê°œë³„ í†µê³„ í•­ëª© */
        .stat {
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            text-align: center;
        }

        .stat .label { font-size: 12px; color: var(--muted); font-weight: 700; letter-spacing: 0.3px; text-transform: uppercase; }
        .stat .value { margin-top: 8px; font-size: 20px; font-weight: 800; color: var(--accent); }

        /* ì§€ë„ ì»¨í…Œì´ë„ˆ */
        #map-container, #map-choropleth {
            width: 100%;
            height: 530px;
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.05);
        }

        /* ì§€ë„ ì •ë³´ í‘œì‹œ */
        .map-info { margin-top: 12px; display: flex; gap: 20px; font-size: 14px; color: var(--muted); }
        .map-info span { color: var(--accent); font-weight: 600; }

        /* ì§€ë„ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .region {
          fill: #ffffff;                        /* ê¸°ë³¸ ì±„ìš°ê¸° ìƒ‰ìƒ */
          stroke: #004c80;                      /* í…Œë‘ë¦¬ ìƒ‰ìƒ */
          stroke-width: 2;                      /* í…Œë‘ë¦¬ ë‘ê»˜ */
          cursor: pointer;                      /* ë§ˆìš°ìŠ¤ ì»¤ì„œ */
          fill-opacity: 0.3;                    /* ì±„ìš°ê¸° íˆ¬ëª…ë„ */
        }
        .region:hover { fill: #e6e6e6; fill-opacity: 0.5; }    /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ */
        .region.active { fill: #808080; fill-opacity: 0.8; }   /* ì„ íƒëœ ìƒíƒœ */

        /* êµ¬ë³„ ì§€ì—­ ìƒ‰ìƒ */
        .ilsandonggu { fill: #f08080; }         /* ì¼ì‚°ë™êµ¬: ì—°í•œ ë¹¨ê°• */
        .deogyanggu { fill: #90ee90; }          /* ë•ì–‘êµ¬: ì—°í•œ ë…¹ìƒ‰ */
        .ilsanseogu { fill: #87ceeb; }          /* ì¼ì‚°ì„œêµ¬: ì—°í•œ íŒŒë‘ */

        /* êµ¬ë³„ í˜¸ë²„ ìƒ‰ìƒ */
        .ilsandonggu:hover { fill: #e57373; }
        .deogyanggu:hover { fill: #77dd77; }
        .ilsanseogu:hover { fill: #6cb4e4; }

        /* êµ¬ë³„ í™œì„±í™” ìƒ‰ìƒ */
        .ilsandonggu.active { fill: #e24e4e; }
        .deogyanggu.active { fill: #66cc66; }
        .ilsanseogu.active { fill: #5ca9e1; }

        /* ë™ ì´ë¦„ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .dong-name { cursor: pointer; font-size: 12px; fill: black; text-anchor: middle; user-select: none; }
        foreignObject { pointer-events: all; } /* ì™¸ë¶€ ê°ì²´ ì´ë²¤íŠ¸ í—ˆìš© */

        /* ì§€ë„ íƒ­ ë²„íŠ¼ */
        .map-tabs { display: flex; gap: 8px; margin: -6px 0 8px; }
        .map-toggle-button {
          padding: 8px 12px;
          border: 1px solid var(--line);
          border-radius: 999px;                 /* ì™„ì „íˆ ë‘¥ê·¼ ëª¨ì„œë¦¬ */
          background: rgba(255, 255, 255, 0.05);
          color: var(--muted);
          font-size: 12px;
          font-weight: 700;
          cursor: pointer;
          transition: all .18s ease;
        }
        .map-toggle-button:hover { border-color: var(--chip-line); background: var(--chip); }
        .map-toggle-button.active { border-color: var(--primary); background: var(--chip); color: var(--primary); }

        /* ì½”ë¡œí”Œë ˆìŠ¤ ì§€ë„ ë²”ë¡€ */
        .choro-legend-wrapper { margin-top: 8px; display: none; }
        .choro-legend-bar { height: 10px; border-radius: 6px; background: linear-gradient(90deg, #cce5ff, #003366); }
        .choro-legend-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-top: 4px; }

        /* íŒŒì´ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .pie-container { height: calc(300px - 80px); display: flex; align-items: center; justify-content: center; padding: 20px 0; }
        .pie-container canvas { max-width: 300px !important; max-height: 300px !important; width: 230px !important; height: 230px !important; }

        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tabs { display: flex; gap: 2px; margin-bottom: 0; border-radius: var(--radius) var(--radius) 0 0; overflow: hidden; flex-shrink: 0; }
        .tab-button { flex: 1; padding: 12px 20px; border: none; background: rgba(255, 255, 255, 0.05); color: var(--muted); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border-bottom: 2px solid transparent; }
        .tab-button:hover { background: rgba(255, 255, 255, 0.08); color: var(--text); }
        .tab-button.active { background: linear-gradient(135deg, var(--primary-strong), var(--primary)); color: white; border-bottom-color: var(--accent); }

        /* íƒ­ ì½˜í…ì¸  ì»¨í…Œì´ë„ˆ */
        .tab-content-container { height: calc(570px - 48px); display: flex; flex-direction: column; }
        .tab-content { height: 100%; display: flex; flex-direction: column; }
        .tab-content .card { margin: 0; border-radius: 0 0 var(--radius) var(--radius); border-top: none; height: 100%; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { height: calc(512px - 80px); overflow-y: auto; border-radius: var(--radius-sm); }
        table { width: 100%; border-collapse: collapse; border-radius: var(--radius); overflow: hidden; }
        th { background: linear-gradient(135deg, var(--primary-strong), var(--primary)); color: white; padding: 14px 16px; text-align: center; font-weight: 700; font-size: 14px; letter-spacing: 0.3px; position: sticky; top: 0; z-index: 10; }
        td { padding: 12px 16px; text-align: center; border-bottom: 1px solid var(--line); background: rgba(255, 255, 255, 0.02); font-size: 14px; transition: background-color 0.2s ease; }
        tr:hover td { background-color: rgba(79, 156, 255, 0.08); }    /* í–‰ í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ */
        tr:nth-child(even) td { background-color: rgba(255, 255, 255, 0.04); } /* ì§ìˆ˜ í–‰ ë°°ê²½ìƒ‰ */
        .count-cell { font-weight: 700; color: var(--accent); }        /* ê±´ìˆ˜ ì…€ ê°•ì¡° */

        /* ë§‰ëŒ€ì°¨íŠ¸ ì˜ì—­ */
        .bar-chart-content { height: calc(512px - 80px); display: flex; flex-direction: column; }
        .gu-selector { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; height: 40px; align-items: center; flex-shrink: 0; }
        .gu-button { padding: 6px 12px; border: 1px solid var(--line); border-radius: 20px; background: rgba(255, 255, 255, 0.03); color: var(--muted); font-size: 12px; cursor: pointer; transition: all 0.2s ease; height: 32px; display: flex; align-items: center; }
        .gu-button:hover { border-color: var(--chip-line); background: var(--chip); }
        .gu-button.active { border-color: var(--primary); background: var(--chip); color: var(--primary); }
        .bar-container { height: calc(100% - 56px); position: relative; }
        .bar-container canvas { width: 100% !important; height: 100% !important; }

        /* ë¡œë”© ìƒíƒœ */
        .loading { display: flex; justify-content: center; align-items: center; padding: 40px; color: var(--muted); }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--line); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ë¹ˆ ìƒíƒœ í‘œì‹œ */
        .empty-state { text-align: center; padding: 40px; color: var(--muted); }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr; height: auto; } /* 1ì—´ë¡œ ë³€ê²½ */
            .left-column { order: 1; }          /* ì™¼ìª½ ì»¬ëŸ¼ ë¨¼ì € */
            .right-column { order: 2; }         /* ì˜¤ë¥¸ìª½ ì»¬ëŸ¼ ë‚˜ì¤‘ì— */
            .pie-section { flex: 0 0 250px; }
            .stats { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 840px) {
            body { transform: scale(1); }       /* ì¶•ì†Œ í•´ì œ */
            .topbar { flex-direction: column; align-items: stretch; }
            .header-left { justify-content: space-between; }
            .controls { justify-content: center; }
            .main-grid { gap: 15px; }
            .stats { grid-template-columns: repeat(2, 1fr); } /* 2ì—´ë¡œ ë³€ê²½ */
            .stat .value { font-size: 18px; }
        }

        @media (max-width: 640px) {
            .stats { grid-template-columns: 1fr; }              /* 1ì—´ë¡œ ë³€ê²½ */
            .gu-selector { justify-content: center; }           /* êµ¬ ì„ íƒê¸° ì¤‘ì•™ ì •ë ¬ */
        }

        /* ì„ íƒëœ í–‰ ê°•ì¡° */
        .highlight-row {
            background-color: rgba(79, 156, 255, 0.15);
            font-weight: bold;
        }

        /* ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€ */
        .no-data {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);     /* ì •ì¤‘ì•™ ìœ„ì¹˜ */
          background: var(--card);
          padding: 20px 30px;
          border: 1px solid var(--line);
          border-radius: var(--radius);
          box-shadow: var(--shadow);
          color: var(--text);
          font-size: 16px;
          font-weight: bold;
          z-index: 99999;                       /* ìµœìƒë‹¨ í‘œì‹œ */
          pointer-events: none;                 /* ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì°¨ë‹¨ */
          text-align: center;
        }

        .no-data.hidden {
          display: none;                        /* ìˆ¨ê¹€ ìƒíƒœ */
        }
    </style>
</head>
<body>
    <div class="wrap">
        <!-- Top bar -->
        <div class="topbar">
            <div class="header-left">
                <a href="../" class="back">
                    â† ë©”ì¸ìœ¼ë¡œ
                </a>
                <h1 class="title">
                    ë¶ˆë²•ì£¼ì •ì°¨ í†µê³„
                    <span class="badge">Analytics</span>
                </h1>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>ê¸°ê°„ ì„ íƒ</label>
                    <select id="periodSelect">
                        <option value="all">ì „ì²´ ê¸°ê°„</option>
                        <option value="week">ìµœê·¼ 7ì¼</option>
                        <option value="month">ìµœê·¼ 30ì¼</option>
                        <option value="year">ìµœê·¼ 1ë…„</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>êµ¬ ì„ íƒ</label>
                    <select id="guSelect">
                        <option value="all">ì „ì²´ êµ¬</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 2x2 Grid Layout -->
        <div class="main-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Summary Stats -->
                <div class="summary-section">
                    <div class="card">
                        <h2>ğŸ“Š í†µê³„ ìš”ì•½</h2>
                        <div class="stats" id="summaryStats">
                            <div class="stat">
                                <div class="label">ì´ ê±´ìˆ˜</div>
                                <div class="value" id="totalCount">-</div>
                            </div>
                            <div class="stat">
                                <div class="label">ë™ë³„ í‰ê·  ê±´ìˆ˜</div>
                                <div class="value" id="avgCount">-</div>
                            </div>
                            <div class="stat">
                                <div class="label">ìµœë‹¤ ì§€ì—­</div>
                                <div class="value" id="maxArea">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map Section -->
                <div class="map-section">
                    <div class="card">
                        <h2>ğŸ—ºï¸ ì§€ì—­ë³„ í˜„í™©</h2>

                        <div id="no-data-message" class="no-data hidden">
                          í•´ë‹¹ ë™ì˜ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </div>

                        <!-- NEW: ì§€ë„ íƒ­ ë²„íŠ¼ -->
                        <div class="map-tabs" aria-label="ì§€ë„ ë³´ê¸° ì „í™˜">
                            <button class="map-toggle-button active" data-map="select" type="button">ë™ ì„ íƒ</button>
                            <button class="map-toggle-button" data-map="choropleth" type="button">ì§€ì—­ë³„ ë¹ˆë„</button>
                        </div>

                        <!-- ê¸°ì¡´ ì§€ë„ (ë™ ì„ íƒ) -->
                        <div id="map-select-wrapper">
                            <svg id="map-container" width="100%" height="400"></svg>
                        </div>

                        <!-- NEW: Choropleth ì§€ë„ ë˜í¼ -->
                        <div id="map-choropleth-wrapper" style="display:none;">
                            <svg id="map-choropleth" width="100%" height="400"></svg>
                            <div id="choro-legend" class="choro-legend-wrapper">
                                <div class="choro-legend-bar"></div>
                                <div class="choro-legend-labels"><span>ë‚®ìŒ</span><span>ë†’ìŒ</span></div>
                            </div>
                        </div>

                        <div class="map-info">
                            <div>ì„ íƒëœ êµ¬ : <span id="selected-gu">ì—†ìŒ</span></div>
                            <div>ì„ íƒëœ ë™ : <span id="selected-dong">ì—†ìŒ</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Pie Chart Section -->
                <div class="pie-section">
                    <div class="card">
                        <h2>ğŸ“Š êµ¬ë³„ ë¶ˆë²•ì£¼ì •ì°¨ í˜„í™©</h2>
                        <div class="pie-container">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Table/Chart Tabs Section -->
                <div class="tabs-section">
                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab-button active" data-tab="table-content">í‘œ</button>
                        <button class="tab-button" data-tab="bar-content">ë§‰ëŒ€ê·¸ë˜í”„</button>
                    </div>

                    <!-- Tab Contents -->
                    <div class="tab-content-container">
                        <div class="tab-content" id="table-content" style="height:470px">
                            <div class="card">
                                <h2>ğŸ“‹ ì§€ì—­ë³„ ë¶ˆë²•ì£¼ì •ì°¨ í˜„í™©</h2>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ë™</th>
                                                <th>ë¶ˆë²•ì£¼ì •ì°¨ ê±´ìˆ˜</th>
                                                <th>ë¹„ìœ¨</th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsTableBody">
                                            <tr>
                                                <td colspan="3" class="loading">
                                                    <div class="spinner"></div>
                                                    ë°ì´í„° ë¡œë”© ì¤‘...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="bar-content" style="display:none; height:470px">
                            <div class="card">
                                <h2>ğŸ“ˆ ë™ë³„ ë¶ˆë²•ì£¼ì •ì°¨ ìƒì„¸í˜„í™©</h2>
                                <div class="bar-chart-content">
                                    <div class="gu-selector" id="guSelector"></div>
                                    <div class="bar-container">
                                        <canvas id="barChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
    // ì°¨íŠ¸ì—ì„œ ì¬ì‚¬ìš©ë˜ëŠ” ì»¬ëŸ¬ ì½”ë“œ ë°°ì—´
    const chartColors = [
        '#2563eb', '#dc2626', '#059669', '#d97706', '#7c3aed',
        '#0891b2', '#be185d', '#65a30d', '#c2410c', '#4338ca'
    ];

    // ë°ì´í„°ì—ì„œ êµ¬, ë™ ì¶”ì¶œ ìœ í‹¸
    function extractGu(district) {
        // ì˜ˆ: "ë•ì–‘êµ¬ í™”ì •ë™" â†’ "ë•ì–‘êµ¬"
        return district.split(' ')[0] || 'ì•Œ ìˆ˜ ì—†ìŒ';
    }
    function extractDong(district) {
        // ì˜ˆ: "ë•ì–‘êµ¬ í™”ì •ë™" â†’ "í™”ì •ë™"
        return district.split(' ')[1] || 'ì•Œ ìˆ˜ ì—†ìŒ';
    }

    // ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
    let pieChart = null;           // íŒŒì´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let barChart = null;           // ë§‰ëŒ€ê·¸ë˜í”„ ì¸ìŠ¤í„´ìŠ¤
    let allData = [];              // í•„í„°ë§ ë° ì§‘ê³„ëœ ë°ì´í„° (êµ¬Â·ë™Â·ê±´ìˆ˜)
    let rawAllData = [];           // ì›ë³¸ ë°ì´í„° (ë‚ ì§œ í¬í•¨)
    let originalPieData = [];      // íŒŒì´ì°¨íŠ¸ìš© ì›ë³¸ ì§‘ê³„ ë°ì´í„°
    let currentSelectedGu = 'all'; // í˜„ì¬ ì„ íƒëœ êµ¬
    let currentSelectedDong = null;// í˜„ì¬ ì„ íƒëœ ë™
    let currentPeriod = 'week';    // í˜„ì¬ ì„ íƒëœ ê¸°ê°„ (ê¸°ë³¸: ìµœê·¼ 7ì¼)

    // ê¸°ê°„ë³„ ë°ì´í„° í•„í„°ë§
    function filterDataByPeriod(data, period) {
        if (period === 'all') return data; // ì „ì²´ ê¸°ê°„ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜

        const now = new Date();
        let cutoffDate;

        // ì„ íƒëœ ê¸°ê°„ì— ë”°ë¼ ê¸°ì¤€ ë‚ ì§œ ì„¤ì •
        switch(period) {
            case 'week':  cutoffDate = new Date(now - 7  * 24 * 60 * 60 * 1000); break;
            case 'month': cutoffDate = new Date(now - 30 * 24 * 60 * 60 * 1000); break;
            case 'year':  cutoffDate = new Date(now - 365* 24 * 60 * 60 * 1000); break;
            default: return data;
        }

        // created_at, timestamp, date ì¤‘ í•˜ë‚˜ë¡œ ë‚ ì§œë¥¼ ì¶”ì¶œí•´ í•„í„°ë§
        return data.filter(item => {
            const itemDate = new Date(item.created_at || item.timestamp || item.date);
            return itemDate >= cutoffDate;
        });
    }

    // êµ¬/ë™ë³„ ë°ì´í„° ì§‘ê³„
    function aggregateDataByDistrict(filteredRawData) {
        const aggregated = {};

        filteredRawData.forEach(item => {
            const district = `${item.gu} ${item.dong}`;
            if (!aggregated[district]) {
                aggregated[district] = { district: district, count: 0 };
            }
            aggregated[district].count++;
        });

        // ê±´ìˆ˜ê°€ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬
        return Object.values(aggregated).sort((a, b) => b.count - a.count);
    }

    // êµ¬ ëª©ë¡ ì´ˆê¸° ë¡œë“œ
    async function loadGuList() {
        try {
            const res = await fetch('/api/illegal_parking/districts/');
            const data = await res.json();
            const gus = Array.from(new Set(data.map(d => extractGu(d))));

            const guSelect = document.getElementById('guSelect');
            guSelect.innerHTML = '<option value="all">ì „ì²´ êµ¬</option>';
            gus.forEach(gu => {
                const option = document.createElement('option');
                option.value = gu;
                option.textContent = gu;
                guSelect.appendChild(option);
            });
        } catch (error) {
            console.error('êµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ìš”ì•½ í†µê³„ ì—…ë°ì´íŠ¸
    function updateSummaryStats(data, selectedGu = 'all') {
        // ì„ íƒëœ êµ¬ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° í•„í„°ë§
        let filteredData = selectedGu === 'all'
            ? data
            : data.filter(item => extractGu(item.district) === selectedGu);

        const totalCount = filteredData.reduce((sum, item) => sum + item.count, 0); // ì´ ê±´ìˆ˜
        const avgCount = filteredData.length > 0
            ? Math.round((totalCount / filteredData.length) * 10) / 10
            : 0; // ë™ë³„ í‰ê·  ê±´ìˆ˜
        const maxItem = filteredData.reduce(
            (max, item) => item.count > max.count ? item : max,
            { count: 0, district: '-' }
        ); // ê±´ìˆ˜ê°€ ê°€ì¥ ë§ì€ ì§€ì—­

        // DOM ì—…ë°ì´íŠ¸
        document.getElementById('totalCount').textContent = totalCount.toLocaleString();
        document.getElementById('avgCount').textContent = avgCount.toLocaleString();
        document.getElementById('maxArea').textContent = extractDong(maxItem.district);
    }

    // ë©”ì¸ ë°ì´í„° ë¡œë“œ ë° í™”ë©´ ê°±ì‹ 
    async function loadTable(period='week', gu='all', drawPie=false) {
        try {
            currentPeriod = period;

            // 1ì°¨ ì‹œë„: ê¸°ê°„ í•„í„°ë§ API
            let url = `/api/illegal_parking/stats/?period=${period}`;
            let res = await fetch(url);
            let data = await res.json();

            // ë°±ì—”ë“œê°€ ê¸°ê°„ í•„í„°ë§ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš°
            if (!data || data.length === 0 || !data[0].hasOwnProperty('district')) {
                url = '/api/illegal_parking/raw/';
                res = await fetch(url);
                rawAllData = await res.json();

                const filteredRawData = filterDataByPeriod(rawAllData, period);
                data = aggregateDataByDistrict(filteredRawData);
            }

            allData = data;

            // ì„ íƒëœ êµ¬ë¡œ ë°ì´í„° í•„í„°ë§
            let filteredData = gu === 'all'
                ? data
                : data.filter(item => extractGu(item.district) === gu);

            currentSelectedGu = gu;

            // êµ¬ë³„ íŒŒì´ì°¨íŠ¸ìš© ë°ì´í„° ì§‘ê³„
            const guData = {};
            allData.forEach(item => {
                const guName = extractGu(item.district);
                guData[guName] = (guData[guName] || 0) + item.count;
            });
            originalPieData = Object.entries(guData)
                .sort((a, b) => b[1] - a[1])
                .map(([guName, count]) => ({ gu: guName, count }));

            // íŒŒì´ì°¨íŠ¸ ê°±ì‹  (ì²˜ìŒ ë¡œë“œí•  ë•Œë§Œ)
            if (drawPie) createPieChart(originalPieData);

            // ìš”ì•½ í†µê³„ ë° ì§€ë„ ê°±ì‹ 
            updateSummaryStats(allData, 'all');
            updateGuSelector(originalPieData);
            updateMapSelection(gu);

            // í‘œ/ë§‰ëŒ€ê·¸ë˜í”„ ê°±ì‹ 
            renderTable(filteredData);
            if (gu === 'all') {
                if (originalPieData.length > 0) createBarChart(originalPieData[0].gu);
            } else {
                createBarChart(gu);
            }

            // Choropleth ì§€ë„ ìƒ‰ìƒ ê°±ì‹ 
            updateChoroplethColors();

        } catch (error) {
            console.error('í†µê³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="empty-state">ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
        }
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(data, isDongSelected=false, highlightDong=null) {
        const tbody = document.getElementById('statsTableBody');
        tbody.innerHTML = '';

        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="empty-state">ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        const totalCount = data.reduce((sum, item) => sum + item.count, 0);

        data.forEach(item => {
            const dong = extractDong(item.district);
            const percentage = totalCount > 0
                ? ((item.count / totalCount) * 100).toFixed(1)
                : '0.0';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${dong}</strong></td>
                <td class="count-cell">${item.count.toLocaleString()}ê±´</td>
                <td>${percentage}%</td>
            `;

            // íŠ¹ì • ë™ ê°•ì¡°
            if (highlightDong && dong === highlightDong) {
                tr.classList.add('highlight-row');
            }

            tbody.appendChild(tr);
        });
    }

    // íŒŒì´ì°¨íŠ¸ ìƒì„±/ê°±ì‹ 
    function createPieChart(guData) {
        const ctx = document.getElementById('pieChart').getContext('2d');

        const guColorMap = {
            'ì¼ì‚°ì„œêµ¬': '#0000cc',
            'ì¼ì‚°ë™êµ¬': '#cc0000',
            'ë•ì–‘êµ¬': '#00aa00'
        };

        const sortedGuData = guData.sort((a, b) => b.count - a.count);
        const pieLabels = sortedGuData.map(item => item.gu);
        const pieCounts = sortedGuData.map(item => item.count);
        const pieColors = pieLabels.map(gu => guColorMap[gu]);

        // ê¸°ì¡´ ì°¨íŠ¸ ê°±ì‹ 
        if (pieChart) {
            pieChart.data.labels = pieLabels;
            pieChart.data.datasets[0].data = pieCounts;
            pieChart.update();
            return;
        }

        // ìƒˆ ì°¨íŠ¸ ìƒì„±
        pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieCounts,
                    backgroundColor: pieColors,
                    borderColor: 'rgba(255,255,255,0.2)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#cbd5e1',
                            usePointStyle: true,
                            padding: 10,
                            generateLabels: chart =>
                                Chart.overrides.pie.plugins.legend.labels.generateLabels(chart).reverse()
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(26,31,41,0.95)',
                        titleColor: '#f7f7f7',
                        bodyColor: '#cbd5e1',
                        borderColor: '#4f9cff',
                        borderWidth: 1,
                        callbacks: {
                            label: ctx => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = ((ctx.raw / total) * 100).toFixed(1);
                                return `${ctx.label}: ${ctx.raw.toLocaleString()}ê±´ (${percent}%)`;
                            }
                        }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const selectedGuFromPie = pieLabels[elements[0].index];
                        selectGuFromPieChart(selectedGuFromPie);
                    }
                }
            }
        });
    }

    // êµ¬ ì„ íƒ ë²„íŠ¼ ì˜ì—­ ê°±ì‹ 
    function updateGuSelector(sortedGuData) {
        const guSelector = document.getElementById('guSelector');
        guSelector.innerHTML = '';

        const activeGu = currentSelectedGu === 'all'
            ? sortedGuData[0]?.gu
            : currentSelectedGu;

        sortedGuData.forEach(item => {
            const button = document.createElement('button');
            button.className = `gu-button ${item.gu === activeGu ? 'active' : ''}`;
            button.textContent = item.gu;
            button.onclick = () => selectGuFromBarChart(item.gu, button);
            guSelector.appendChild(button);
        });
    }

    // ë§‰ëŒ€ê·¸ë˜í”„ ìƒì„±
    function createBarChart(selectedGu, highlightDong=null) {
        const ctx = document.getElementById('barChart').getContext('2d');
        if (barChart) barChart.destroy();

        const dongData = allData
            .filter(item => extractGu(item.district) === selectedGu)
            .sort((a, b) => b.count - a.count);

        const labels = dongData.map(item => extractDong(item.district));
        const counts = dongData.map(item => item.count);

        // ë™ ê°•ì¡° ìƒ‰ìƒ ì²˜ë¦¬
        const backgroundColors = labels.map(dong =>
            (highlightDong && dong === highlightDong)
                ? 'rgba(220,38,38,0.8)' // ê°•ì¡°: ë¹¨ê°•
                : 'rgba(79,156,255,0.8)' // ê¸°ë³¸: íŒŒë‘
        );
        const borderColors = labels.map(dong =>
            (highlightDong && dong === highlightDong)
                ? 'rgba(220,38,38,1)'
                : 'rgba(79,156,255,1)'
        );

        // ì°¨íŠ¸ ìƒì„±
        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'ë¶ˆë²•ì£¼ì •ì°¨ ê±´ìˆ˜',
                    data: counts,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y', // ê°€ë¡œí˜• ë§‰ëŒ€ê·¸ë˜í”„ ì„¤ì •.
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { color: '#9ca3af', font: { size: 12 } },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        ticks: { color: '#9ca3af', font: { size: 12 } },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(26,31,41,0.95)',
                        titleColor: '#f7f7f7',
                        bodyColor: '#cbd5e1',
                        borderColor: '#4f9cff',
                        borderWidth: 1,
                        callbacks: {
                            label: ctx => `${ctx.label}: ${ctx.raw.toLocaleString()}ê±´`
                        }
                    }
                }
            }
        });
    }

    // íŠ¹ì • ë™ ì„ íƒ ì‹œ ì‹¤í–‰
    function selectDong(dongName, gu) {
        currentSelectedDong = dongName;
        currentSelectedGu = gu;
        document.getElementById('guSelect').value = gu;

        updateSummaryStats(allData, 'all');

        // êµ¬ ë²„íŠ¼ í™œì„±í™” ê°±ì‹ 
        document.querySelectorAll('.gu-button').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === gu);
        });

        const guData = allData.filter(item => extractGu(item.district) === gu);
        const hasDong = guData.some(item => extractDong(item.district) === dongName);

        if (!hasDong) {
            showNoDataMessage();
        } else {
            hideNoDataMessage();
        }

        renderTable(guData, false, hasDong ? dongName : null);
        createBarChart(gu, hasDong ? dongName : null);
    }

    // íŒŒì´ì°¨íŠ¸ì—ì„œ êµ¬ ì„ íƒ ì‹œ ì‹¤í–‰
    function selectGuFromPieChart(selectedGu) {
        currentSelectedDong = null;
        document.getElementById('guSelect').value = selectedGu;
        currentSelectedGu = selectedGu;

        updateSummaryStats(allData, 'all');
        updateMapSelection(selectedGu);

        // êµ¬ ë²„íŠ¼ í™œì„±í™” ê°±ì‹ 
        document.querySelectorAll('.gu-button').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === selectedGu);
        });

        const filteredData = allData.filter(item => extractGu(item.district) === selectedGu);
        renderTable(filteredData);
        createBarChart(selectedGu);
        updateChoroplethColors();
    }

    // ë§‰ëŒ€ê·¸ë˜í”„ì—ì„œ êµ¬ ì„ íƒ ì‹œ ì‹¤í–‰
    function selectGuFromBarChart(selectedGu, buttonElement) {
        currentSelectedDong = null;
        document.getElementById('guSelect').value = selectedGu;
        currentSelectedGu = selectedGu;

        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°±ì‹ 
        document.querySelectorAll('.gu-button').forEach(btn => btn.classList.remove('active'));
        buttonElement.classList.add('active');

        updateSummaryStats(allData, 'all');
        updateMapSelection(selectedGu);

        const filteredData = allData.filter(item => extractGu(item.district) === selectedGu);
        renderTable(filteredData);
        createBarChart(selectedGu);
        updateChoroplethColors();
    }
    // êµ¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì²˜ë¦¬
    function selectGuFromSelectBox(selectedGu) {
        currentSelectedDong = null;
        currentSelectedGu = selectedGu;
        updateSummaryStats(allData, 'all');
        updateMapSelection(selectedGu);
        if (selectedGu === 'all') {
            const firstGu = originalPieData[0]?.gu;
            if (firstGu) {
                document.querySelectorAll('.gu-button').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent === firstGu);
                });
                createBarChart(firstGu);
            }
            renderTable(allData);
        } else {
            document.querySelectorAll('.gu-button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === selectedGu);
            });
            const filteredData = allData.filter(item => extractGu(item.district) === selectedGu);
            renderTable(filteredData);
            createBarChart(selectedGu);
        }
        updateChoroplethColors();
    }

    // ===== ì§€ë„ ê´€ë ¨ í•¨ìˆ˜ë“¤ =====

    // ì§€ë„ ì„ íƒ ìƒíƒœ(êµ¬) ì—…ë°ì´íŠ¸
    function updateMapSelection(selectedGu) {
        if (selectedGu === 'all') {
            d3.select('#map-container').selectAll('path').classed('active', false);
            document.getElementById('selected-gu').textContent = 'ì—†ìŒ';
            document.getElementById('selected-dong').textContent = 'ì—†ìŒ';
        } else {
            if (!currentSelectedDong) {
                d3.select('#map-container').selectAll('path').classed('active', function(d) {
                    return d && d.properties && d.properties.gu === selectedGu;
                });
                document.getElementById('selected-gu').textContent = selectedGu;
                document.getElementById('selected-dong').textContent = 'ì „ì²´';
            }
        }
    }

    // ì§€ë„ ì„ íƒ ìƒíƒœ(ë™) ì—…ë°ì´íŠ¸
    function updateMapSelectionForDong(dongName, gu) {
        d3.select('#map-container').selectAll('path').classed('active', false);
        d3.select('#map-container').selectAll('path').classed('active', function(d) {
            return d && d.properties && d.properties.A2 === dongName;
        });
        document.getElementById('selected-gu').textContent = gu;
        document.getElementById('selected-dong').textContent = dongName;
    }

    // ===== D3 ì§€ë„ ë¡œë“œ =====
    const svg = d3.select('#map-container');
    const mapContainer = document.querySelector('#map-container');
    const width = mapContainer.clientWidth;
    const height = 520;
    svg.attr('width', width).attr('height', height);

    const svgChoro = d3.select('#map-choropleth');
    svgChoro.attr('width', width).attr('height', height);
    // ê³ ì–‘ì‹œ GeoJSON íŒŒì¼ ë¡œë“œ
    d3.json('/static/geojson/goyang.geojson').then(data => {
        const dongToGu = {
            "ì£¼êµë™": "ë•ì–‘êµ¬", "ì„±ì‚¬ë™": "ë•ì–‘êµ¬", "ì›ë‹¹ë™": "ë•ì–‘êµ¬",
            "ì‹ ì›ë™": "ë•ì–‘êµ¬", "ì›í¥ë™": "ë•ì–‘êµ¬", "ë„ë‚´ë™": "ë•ì–‘êµ¬",
            "ë¶í•œë™": "ë•ì–‘êµ¬", "íš¨ìë™": "ë•ì–‘êµ¬", "ì§€ì¶•ë™": "ë•ì–‘êµ¬",
            "ì˜¤ê¸ˆë™": "ë•ì–‘êµ¬", "ì‚¼ì†¡ë™": "ë•ì–‘êµ¬", "ë™ì‚°ë™": "ë•ì–‘êµ¬",
            "ìš©ë‘ë™": "ë•ì–‘êµ¬", "ë²½ì œë™": "ë•ì–‘êµ¬", "ì„ ìœ ë™": "ë•ì–‘êµ¬",
            "ê³ ì–‘ë™": "ë•ì–‘êµ¬", "ëŒ€ìë™": "ë•ì–‘êµ¬", "ê´€ì‚°ë™": "ë•ì–‘êµ¬",
            "ë‚´ìœ ë™": "ë•ì–‘êµ¬", "í† ë‹¹ë™": "ë•ì–‘êµ¬", "ë‚´ê³¡ë™": "ë•ì–‘êµ¬",
            "ëŒ€ì¥ë™": "ë•ì–‘êµ¬", "ì‹ í‰ë™": "ë•ì–‘êµ¬", "í™”ì •ë™": "ë•ì–‘êµ¬",
            "í–‰ì£¼ë‚´ë™": "ë•ì–‘êµ¬", "í–‰ì£¼ì™¸ë™": "ë•ì–‘êµ¬", "í–‰ì‹ ë™": "ë•ì–‘êµ¬",
            "ê°•ë§¤ë™": "ë•ì–‘êµ¬", "í™”ì „ë™": "ë•ì–‘êµ¬", "ë•ì€ë™": "ë•ì–‘êµ¬",
            "í–¥ë™ë™": "ë•ì–‘êµ¬", "í˜„ì²œë™": "ë•ì–‘êµ¬",
            "ì„¤ë¬¸ë™": "ì¼ì‚°ë™êµ¬", "ì§€ì˜ë™": "ì¼ì‚°ë™êµ¬", "ì„±ì„ë™": "ì¼ì‚°ë™êµ¬",
            "ë¬¸ë´‰ë™": "ì¼ì‚°ë™êµ¬", "ì‚¬ë¦¬í˜„ë™": "ì¼ì‚°ë™êµ¬", "ì¤‘ì‚°ë™": "ì¼ì‚°ë™êµ¬",
            "ì‹ì‚¬ë™": "ì¼ì‚°ë™êµ¬", "ì •ë°œì‚°ë™": "ì¼ì‚°ë™êµ¬", "ë§ˆë‘ë™": "ì¼ì‚°ë™êµ¬",
            "í’ë™": "ì¼ì‚°ë™êµ¬", "ì¥í•­ë™": "ì¼ì‚°ë™êµ¬", "ë°±ì„ë™": "ì¼ì‚°ë™êµ¬",
            "ì‚°í™©ë™": "ì¼ì‚°ë™êµ¬",
            "êµ¬ì‚°ë™": "ì¼ì‚°ì„œêµ¬", "ê°€ì¢Œë™": "ì¼ì‚°ì„œêµ¬", "ë•ì´ë™": "ì¼ì‚°ì„œêµ¬",
            "íƒ„í˜„ë™": "ì¼ì‚°ì„œêµ¬", "ë²•ê³³ë™": "ì¼ì‚°ì„œêµ¬", "ëŒ€í™”ë™": "ì¼ì‚°ì„œêµ¬",
            "ì£¼ì—½ë™": "ì¼ì‚°ì„œêµ¬", "ì¼ì‚°ë™": "ì¼ì‚°ì„œêµ¬"
        };

        data.features.forEach(f => {
            const dong = f.properties.A2;
            f.properties.gu = dongToGu[dong] || "ê¸°íƒ€";
        });

        const projection = d3.geoMercator().fitSize([width, height], data);
        const path = d3.geoPath().projection(projection);

        const dongOffset = {
            "í–‰ì£¼ì™¸ë™": {x: -15, y: 1},
            "í–‰ì£¼ë‚´ë™": {x: -19, y: -18},
            "ëŒ€ì¥ë™": {x: -2, y: -12},
            "ì§€ì¶•ë™": {x: -5, y: 0},
            "ì‹ í‰ë™": {x: 0, y: -3}
        };

        // ì„ íƒ ì§€ë„ path
        svg.selectAll('path')
        .data(data.features)
        .enter()
        .append('path')
        .attr('d', path)
        .attr('class', d => {
            if(d.properties.gu === 'ì¼ì‚°ë™êµ¬') return 'region ilsandonggu';
            if(d.properties.gu === 'ë•ì–‘êµ¬') return 'region deogyanggu';
            if(d.properties.gu === 'ì¼ì‚°ì„œêµ¬') return 'region ilsanseogu';
            return 'region';
        })
        .on('click', function(event, d) {
            const dongName = d.properties.A2;
            const gu = d.properties.gu;

            // ë°ì´í„° í™•ì¸ í›„ ì²˜ë¦¬
            const dongData = allData.filter(item =>
                extractGu(item.district) === gu &&
                extractDong(item.district) === dongName
            );

            if (dongData.length === 0) {
                showNoDataMessage();
            } else {
                hideNoDataMessage();
            }

            selectDong(dongName, gu);
            updateMapSelectionForDong(dongName, gu);
        });

        // ë™ ì´ë¦„ í‘œì‹œ
        svg.selectAll('foreignObject')
            .data(data.features)
            .enter()
            .append('foreignObject')
            .attr('x', d => path.centroid(d)[0] + (dongOffset[d.properties.A2]?.x || -20))
            .attr('y', d => path.centroid(d)[1] + (dongOffset[d.properties.A2]?.y || -10))
            .attr('width', d => d.properties.A2.length * 10 + 10)
            .attr('height', 20)
            .append('xhtml:div')
            .html(d => `<span class="dong-name">${d.properties.A2}</span>`)
            .on('click', function(event, d) {
                const dongName = d.properties.A2;
                const gu = d.properties.gu;

                // ë°ì´í„° í™•ì¸ í›„ ì²˜ë¦¬
                const dongData = allData.filter(item =>
                    extractGu(item.district) === gu &&
                    extractDong(item.district) === dongName
                );

                if (dongData.length === 0) {
                    showNoDataMessage();
                } else {
                    hideNoDataMessage();
                }

                selectDong(dongName, gu);
                updateMapSelectionForDong(dongName, gu);
            });

        // Choropleth ì§€ë„ path
        const pathChoro = d3.geoPath().projection(projection);

        svgChoro.selectAll('path')
        .data(data.features)
        .enter()
        .append('path')
        .attr('d', pathChoro)
        .attr('class', 'region choropleth')
        .on('click', function(event, d) {
            const dongName = d.properties.A2;
            const gu = d.properties.gu;

            // ë°ì´í„° í™•ì¸ í›„ ì²˜ë¦¬
            const dongData = allData.filter(item =>
                extractGu(item.district) === gu &&
                extractDong(item.district) === dongName
            );

            if (dongData.length === 0) {
                showNoDataMessage();
            } else {
                hideNoDataMessage();
            }

            selectDong(dongName, gu);
            updateMapSelectionForDong(dongName, gu);
        })

    const tooltipGroup = svgChoro.append("g")
        .attr("id", "svg-tooltip-group")
        .style("pointer-events", "none")
        .style("z-index", 9999);

    const tooltipFo = tooltipGroup.append("foreignObject")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 120)
        .attr("height", 30)
        .style("display", "none");

    const tooltipDiv = tooltipFo.append("xhtml:div")
        .attr("id", "svg-tooltip")
        .style("pointer-events", "none")
        .style("background", "rgba(0, 0, 0, 0.6)")
        .style("color", "white")
        .style("font-size", "12px")
        .style("border-radius", "6px")
        .style("padding", "4px 8px")
        .style("white-space", "nowrap")
        .style("box-shadow", "0 4px 12px rgba(0,0,0,0.5)")
        .style("font-weight", "600")
        .style("user-select", "none")
        .style("width", "120px")
        .style("height", "30px")
        .style("line-height", "22px")
        .style("text-align", "center")
        .style("box-sizing", "border-box")
        .style("display", "flex")
        .style("justify-content", "center")
        .style("align-items", "center");

    // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì´ë²¤íŠ¸
    svgChoro.selectAll("path")
        .on("mouseover", function(event, d) {
            d3.select(this)
            .transition().duration(100)
            .style("stroke-width", "3px");
            const [x, y] = pathChoro.centroid(d);

            tooltipFo
                .attr("x", x - 60)
                .attr("y", y - 40)
                .style("display", "block");

            tooltipDiv.html(`${d.properties.gu} ${d.properties.A2}`);

            d3.select(this).attr("stroke-width", 3);
        })
        .on("mouseout", function() {
            d3.select(this)
            .transition().duration(100)
            .style("stroke-width", "2px");
            tooltipFo.style("display", "none");
            d3.select(this).attr("stroke-width", 1);
        });


    // ì´ˆê¸° ìƒ‰ì±„ìš°ê¸° (ë°ì´í„° ë¡œë“œ ì „ì—” ì—°í•œìƒ‰)
    svgChoro.selectAll('path').style('fill', '#eaf3ff');

    }).catch(error => { console.error('GeoJSON ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error); });

    // Choropleth ìƒ‰ìƒ ì—…ë°ì´íŠ¸
    function updateChoroplethColors() {
        const paths = svgChoro.selectAll('path');
        if (paths.empty()) return; // ì§€ë„ ì•„ì§ ì•ˆ ê·¸ë ¤ì§„ ê²½ìš°

        const maxCount = d3.max(allData, d => d.count) || 0;
        const colorScale = d3.scaleLinear().domain([0, maxCount]).range(['#cce5ff', '#003366']);
        const countsByDong = new Map(allData.map(item => [extractDong(item.district), item.count]));

        paths
        .transition().duration(350)
        .style('fill', d => {
            const val = countsByDong.get(d.properties.A2);
            return (val != null) ? colorScale(val) : '#eee';
        })
        .style('fill-opacity', 0.9)
        .style('stroke', '#004c80')
        .style('stroke-width', 1);

        // ë²”ë¡€ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ ìƒíƒœ ë™ê¸°í™”
        const legend = document.getElementById('choro-legend');
        if (legend) {
            legend.style.display = document.getElementById('map-choropleth-wrapper').style.display === 'none' ? 'none' : 'block';
            legend.innerHTML = `
                <div class="choro-legend-bar"></div>
                <div class="choro-legend-labels"><span>0</span><span>${maxCount.toLocaleString()}ê±´</span></div>
            `;
        }
    }

    // ì§€ë„ ë³´ê¸° ì „í™˜ ë²„íŠ¼
    document.querySelectorAll('.map-toggle-button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.map-toggle-button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const type = btn.dataset.map;
            if (type === 'choropleth') {
                document.getElementById('map-select-wrapper').style.display = 'none';
                document.getElementById('map-choropleth-wrapper').style.display = 'block';
                updateChoroplethColors();
            } else {
                document.getElementById('map-select-wrapper').style.display = 'block';
                document.getElementById('map-choropleth-wrapper').style.display = 'none';
            }
        });
    });

    // ìˆ˜ì •ëœ í˜ì´ì§€ ë¡œë”©
    window.onload = async () => {
        await loadGuList();

        const periodSelect = document.getElementById('periodSelect');
        const guSelect = document.getElementById('guSelect');

        // ì „ì²´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (íŒŒì´ì°¨íŠ¸ ìƒì„± í¬í•¨)
        await loadTable(periodSelect.value, 'all', true);

        // ìˆ˜ì •ëœ ê¸°ê°„ ì„ íƒ ì´ë²¤íŠ¸ - íŒŒì´ì°¨íŠ¸ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
        periodSelect.addEventListener('change', async () => {
            const selectedPeriod = periodSelect.value;
            const selectedGu = guSelect.value;

            // ê¸°ê°„ì´ ë³€ê²½ë˜ë©´ íŒŒì´ì°¨íŠ¸ë„ ìƒˆë¡œ ìƒì„±
            await loadTable(selectedPeriod, selectedGu, true);
        });

        // êµ¬ ì„ íƒ ì´ë²¤íŠ¸
        guSelect.addEventListener('change', () => {
            const selectedGu = guSelect.value;
            selectGuFromSelectBox(selectedGu);

            // ê¸°ê°„ì€ ê·¸ëŒ€ë¡œ ë‘ê³  êµ¬ë§Œ ë³€ê²½
            loadTable(currentPeriod, selectedGu);
        });
    };

    // íƒ­ ê¸°ëŠ¥ (ì˜¤ë¥¸ìª½ í‘œ/ê·¸ë˜í”„)
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.dataset.tab;
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            tabContents.forEach(content => {
                content.style.display = (content.id === target) ? 'block' : 'none';
            });
        });
    });

    // "ë°ì´í„° ì—†ìŒ" ë©”ì‹œì§€ í™”ë©´ ì¶œë ¥
    function showNoDataMessage() {
        const messageBox = document.getElementById('no-data-message');
        if (messageBox) {
            messageBox.classList.remove('hidden');

            // 3ì´ˆ ë’¤ ìë™ ìˆ¨ê¹€
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 1000);
        }
    }
    // "ë°ì´í„° ì—†ìŒ" ë©”ì‹œì§€ íˆë“  ìƒíƒœë¡œ.
    function hideNoDataMessage() {
        const messageBox = document.getElementById('no-data-message');
        if (messageBox) {
            messageBox.classList.add('hidden');
        }
    }

    // íŠ¹ì • "ë™" í´ë¦­ ì‹œ ë°ì´í„° í•„í„°ë§ í›„ ì°¨íŠ¸ë¥¼ ì—…ë°ì´íŠ¸
    function handleDongClick(selectedDong) {
        const dongData = allData.filter(item => extractDong(item.district) === selectedDong);
        console.log("í´ë¦­í•œ ë™:", selectedDong, "dongData ê¸¸ì´:", dongData.length); // <- ì—¬ê¸° í™•ì¸

        if (dongData.length === 0) {
            showNoDataMessage();
            updateCharts([]);
        } else {
            hideNoDataMessage();
            updateCharts(dongData);
        }
    }
    </script>
</body>
</html>
