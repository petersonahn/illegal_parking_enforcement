// ë²”ì¹™ê¸ˆ ì•ˆë‚´ íŒì—…
let fineOverlay = null;

function placeRandomOnRoad() {
  if (!isAuthenticated) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); return; }
  if (!roadLines.length) { alert('ë„ë¡œ ë°ì´í„°ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }

  // ê¸°ì¡´ ìš”ì†Œ ì •ë¦¬
  if (carMarker) { carMarker.setMap(null); carMarker = null; }
  if (infoWindow) { infoWindow.setMap(null); infoWindow = null; }
  parkingMarkers.forEach(m => m.setMap(null));
  parkingMarkers.length = 0;

  // ê¸°ì¡´ ë²”ì¹™ê¸ˆ ì•ˆë‚´ íŒì—… ë‹«ê¸°
  if (fineOverlay) { fineOverlay.setMap(null); fineOverlay = null; }

  const line = roadLines[Math.floor(Math.random() * roadLines.length)];
  const dist = Math.random() * turf.length(line, { units: 'kilometers' });
  const pt = turf.along(line, dist, { units: 'kilometers' });
  const [lon, lat] = pt.geometry.coordinates;

  carMarker = new kakao.maps.Marker({ map, position: new kakao.maps.LatLng(lat, lon) });
  map.setCenter(new kakao.maps.LatLng(lat, lon));
  currentCarLocation = [lat, lon];

  const illegal = isIllegalParkingArea(lat, lon);
  const msg = illegal
    ? `ğŸš« ë¶ˆë²• ì£¼ì •ì°¨ êµ¬ì—­ì…ë‹ˆë‹¤.<br>
       <span style="font-size:12px; color:#555;">â€» ë²”ì¹™ê¸ˆ ì•ˆë‚´ (í´ë¦­)</span>`
    : "âœ… ë¶ˆë²• ì£¼ì •ì°¨ êµ¬ì—­ì´ ì•„ë‹™ë‹ˆë‹¤.";

  infoWindow = new kakao.maps.CustomOverlay({
    content: `<div id="illegalMsgBox"
                  style="padding:12px;font-size:16px;font-weight:bold;min-width:220px;text-align:center;
                         background:#fff; border:2px solid ${illegal?'#dc3545':'#28a745'};
                         border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);
                         color:${illegal?'#dc3545':'#28a745'}; cursor:${illegal?'pointer':'default'}">
                ${msg}
              </div>`,
    position: new kakao.maps.LatLng(lat, lon),
    yAnchor: 1.8, zIndex: 99
  });
  infoWindow.setMap(map);

  if (illegal) {
    recordIllegalParking(lat, lon);
    showNearbyParkingLots(lat, lon);

    const center = turf.point([lon, lat]);
    const nearby = parkingLots.filter(lot =>
      turf.distance(center, turf.point([lot.longitude, lot.latitude]), { units: 'kilometers' }) <= nearByParkingLotsDistance
    );
    renderParkingList(nearby);

    setTimeout(() => {
      const msgBox = document.getElementById('illegalMsgBox');
      if (msgBox) {
        msgBox.addEventListener('click', () => {
          // í´ë¦­ ì „ì— ê¸°ì¡´ íŒì—… ë‹«ê¸°
          if (fineOverlay) { fineOverlay.setMap(null); fineOverlay = null; }

          fineOverlay = new kakao.maps.CustomOverlay({
            content: `
              <div style="background:white; border:2px solid #dc3545; border-radius:6px;
                          padding:10px; font-size:14px; color:#333; min-width:220px; box-shadow:0 2px 6px rgba(0,0,0,0.3);">
                <strong style="color:#dc3545;">ë¶ˆë²• ì£¼ì •ì°¨ ë²”ì¹™ê¸ˆ ì•ˆë‚´</strong><br>
                Â· ì¼ë°˜ì§€ì—­ : <b>ìŠ¹ìš©ì°¨ 4ë§Œì›, ìŠ¹í•©ì°¨ 5ë§Œì›</b><br>
                Â· íŠ¹ë³„êµ¬ì—­ : <b>ì†Œë°©ì‹œì„¤ ì£¼ë³€ 8ë§Œì›, ì–´ë¦°ì´ë³´í˜¸êµ¬ì—­ 12ë§Œì›</b><br>
                <span style="font-size:12px; color:#555;">â€» ì§€ì—­Â·ìƒí™©ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
              </div>
            `,
            position: new kakao.maps.LatLng(lat, lon),
            yAnchor: 2.8,
            zIndex: 200
          });
          fineOverlay.setMap(map);

          setTimeout(() => {
            if (fineOverlay) { fineOverlay.setMap(null); fineOverlay = null; }
          }, 10000);
        });
      }
    }, 100);
  } else {
    renderParkingList();
  }
}

// ì£¼Â·ì •ì°¨ ì·¨ì†Œ ë²„íŠ¼
function clearMarkers() {
  if (!isAuthenticated) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); return; }

  if (carMarker) { carMarker.setMap(null); carMarker = null; }
  parkingMarkers.forEach(m => m.setMap(null));
  parkingMarkers.length = 0;
  renderParkingList();
  if (infoWindow) { infoWindow.setMap(null); infoWindow = null; }

  // íŒì—… ë‹«ê¸°
  if (fineOverlay) { fineOverlay.setMap(null); fineOverlay = null; }
}


// ì£¼Â·ì •ì°¨ ì·¨ì†Œ ë²„íŠ¼
function clearMarkers() {
  if (!isAuthenticated) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); return; }

  if (carMarker) { carMarker.setMap(null); carMarker = null; }
  parkingMarkers.forEach(m => m.setMap(null));
  parkingMarkers.length = 0;
  renderParkingList();
  if (infoWindow) { infoWindow.setMap(null); infoWindow = null; }
  

  // ê¸°ì¡´ ë²”ì¹™ê¸ˆ ì•ˆë‚´ íŒì—… ë‹«ê¸°
  if (fineOverlay) { fineOverlay.setMap(null); fineOverlay = null; }
}
