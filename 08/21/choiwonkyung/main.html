<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ë¶ˆë²• ì£¼ì •ì°¨ êµ¬ì—­ ì•ˆë‚´ ì„œë¹„ìŠ¤</title>
  <style>
    html, body {
      height: 100%;
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    /* ìƒë‹¨ ë°°ë„ˆ ìŠ¤íƒ€ì¼ */
    #header {
      height: 60px;
      background: #004c99;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-sizing: border-box;
      flex-shrink: 0;
    }
    #header h1 { margin: 0; font-size: 20px; }
    #header button {
      background: #007bff;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #header button:hover { background: #0056b3; }

    /* ì¢Œìš° ì½˜í…ì¸  ë ˆì´ì•„ì›ƒ */
    #container {
      flex: 1;
      display: flex;
      height: calc(100% - 60px);
    }
    /* ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
    #parkingList {
      width: 300px;
      border-right: 1px solid #ddd;
      box-sizing: border-box;
      padding: 15px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    #parkingList h2 { margin-top: 0; font-size: 18px; margin-bottom: 6px; color: #333; }
    #sortSelect {
      margin-bottom: 12px;
      width: 100%;
      padding: 5px;
      font-size: 14px;
    }
    #parkingUl { list-style: none; padding-left: 0; margin: 0; }
    #parkingUl li {
      padding: 8px 10px;
      border-radius: 4px;
      margin-bottom: 6px;
      background: white;
      border: 1px solid #ccc;
      transition: background-color 0.2s;
    }
    #parkingUl li:hover { background-color: #e6f0ff; border-color: #007bff; }

    /* ìš°ì¸¡ ì§€ë„ ì˜ì—­ */
    #mapContainer {
      flex: 1;
      position: relative;
      background: #eee;
      display: flex;
      flex-direction: column;
    }
    #map { flex: 1; position: relative; }

    button#placeCarBtn,
    button#clearBtn {
      position: absolute;
      top: 10px;
      z-index: 100;
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      user-select: none;
      transition: background-color 0.2s;
    }
    button#placeCarBtn:hover,
    button#clearBtn:hover { background-color: #0056b3; }
    button#placeCarBtn { left: 10px; }
    button#clearBtn { left: 120px; }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #loadingOverlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      z-index: 50;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: bold; color: #444;
      user-select: none;
    }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed; z-index: 200;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 400px;
      border-radius: 5px;
      position: relative;
    }
     .modal-content h2 {
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 15px;
      color: #333;
    }

    .close {
      position: absolute;
      top: 10px; right: 15px;
      color: #aaa;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover { color: #000; }

    .modal-content input[type=text],
    .modal-content input[type=password],
    .modal-content input[type=email] {
      width: 100%;
      padding: 6px;
      margin: 4px 0 10px;
      box-sizing: border-box;
    }
  </style>

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f4c124856678656d1b266147d1cb459e&autoload=false"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
</head>
<body>

    <!-- Django ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->

  {% if messages %}
  <div id="django-messages" style="
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
  ">
    {% for message in messages %}
      <div class="message-box" style="
          padding: 10px 15px;
          border-radius: 6px;
          color: white;
          min-width: 220px;
          font-weight: bold;
          box-shadow: 0 2px 6px rgba(0,0,0,0.2);
          opacity: 0;
          transform: translateY(-10px);
          transition: opacity 0.5s, transform 0.5s;
          background:
            {% if message.tags == 'success' %}#28a745
            {% elif message.tags == 'error' %}#dc3545
            {% else %}#007bff{% endif %};
      ">
        {{ message }}
      </div>
    {% endfor %}
  </div>
    {% endif %}

  <!-- ìƒë‹¨ Header -->
  <div id="header">
  <h1>ë¶ˆë²• ì£¼ì •ì°¨ êµ¬ì—­ ì•ˆë‚´ ì„œë¹„ìŠ¤</h1>
  <div id="userControls">
  {% if user.is_authenticated %}
    <span>ì•ˆë…•í•˜ì„¸ìš”, {{ user.username }}ë‹˜</span>
    <button onclick="openModal('profileModal')"
        style="padding:6px 12px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer;">
          ë§ˆì´í˜ì´ì§€
    </button>
    <form method="POST" action="{% url 'accounts:logout' %}" style="display:inline;">
      {% csrf_token %}
      <button type="submit" style="padding:6px 12px; background:#dc3545; color:#fff; border:none; border-radius:4px; cursor:pointer;">
        ë¡œê·¸ì•„ì›ƒ
      </button>
    </form>
  {% else %}
    <button onclick="openModal('loginModal')">ë¡œê·¸ì¸</button>
    <button onclick="openModal('signupModal')">íšŒì›ê°€ì…</button>
  {% endif %}
</div>
</div>

  <!-- ì¢Œìš° ì½˜í…ì¸  ì˜ì—­ -->
  <div id="container">
    <div id="parkingList">
      <h2>ì£¼ì°¨ì¥ ë¦¬ìŠ¤íŠ¸</h2>
      <select id="sortSelect" onchange="handleSortChange()">
        <option value="name">ì´ë¦„ìˆœ</option>
        <option value="distance">ê±°ë¦¬ìˆœ</option>
      </select>
      <ul id="parkingUl"></ul>
    </div>
    <div id="mapContainer">
      <div id="map">
        <div id="loadingOverlay">ğŸ›£ ë„ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      </div>
      <button id="placeCarBtn" onclick="placeRandomOnRoad()">ì°¨ëŸ‰ ì£¼ì°¨</button>
      <button id="clearBtn" onclick="clearMarkers()">ë§ˆì»¤ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <!-- ì£¼ì°¨ì¥ ìƒì„¸ ëª¨ë‹¬ -->
  <div id="parkingModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeParkingModal()">&times;</span>
      <div id="parkingModalBody"></div>
    </div>
  </div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('loginModal')">&times;</span>
      <h2>ë¡œê·¸ì¸</h2>
      <form method="POST" action="{% url 'accounts:login' %}">
        {% csrf_token %}
        <label for="login-username">ì•„ì´ë””:</label><br>
        <input type="text" id="login-username" name="username" required><br>
        <label for="login-password">ë¹„ë°€ë²ˆí˜¸:</label><br>
        <input type="password" id="login-password" name="password" required><br>
        <button type="submit" style="padding:6px 12px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer;">ë¡œê·¸ì¸</button>
        <button type="button" onclick="openModal('findIdModal')"
          style="padding:6px 12px; margin-left:10px; background:#ffc107; color:#fff; border:none; border-radius:4px; cursor:pointer;">
          ì•„ì´ë”” ì°¾ê¸°
        </button>
        <button type="button" onclick="openModal('resetModal')"
        style="padding:6px 12px; margin-left:10px; background:#17a2b8; color:#fff; border:none; border-radius:4px; cursor:pointer;">
        ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
        </button>
      </form>



    </div>
  </div>

  <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="signupModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('signupModal')">&times;</span>
    <h2>íšŒì›ê°€ì…</h2>
    <form id="signupForm" method="POST" action="{% url 'accounts:signup' %}">
      {% csrf_token %}

      <label for="signup-username">ì•„ì´ë””:</label><br>
      <input type="text" id="signup-username" name="username" required>
      <span class="error" id="error-username" style="color:red; font-size:0.9em;"></span><br>

      <label for="signup-full_name">ì´ë¦„:</label><br>
      <input type="text" id="signup-full_name" name="full_name" required><br>

      <label for="signup-phone_number">í•¸ë“œí° ë²ˆí˜¸:</label><br>
      <input type="text" id="signup-phone_number" name="phone_number" required><br>

      <label for="signup-car_number">ì°¨ëŸ‰ ë²ˆí˜¸:</label><br>
      <input type="text" id="signup-car_number" name="car_number" required><br>

      <label for="signup-email">ì´ë©”ì¼:</label><br>
      <input type="email" id="signup-email" name="email" required
             placeholder="ì´ë©”ì¼ í˜•ì‹ ex) User@domain.com ì™€ ê°™ì€ í˜•ì‹ì„ ì§€ì¼œì£¼ì„¸ìš”">
      <span class="error" id="error-email" style="color:red; font-size:0.9em;"></span><br>

      <label for="signup-password1">ë¹„ë°€ë²ˆí˜¸:</label><br>
      <input type="password" id="signup-password1" name="password1" required
                   placeholder="ì—°ì†ë˜ì§€ ì•Šì€ ì˜ë¬¸ ìˆ«ì ì¡°í•© 8ìë¦¬ ì´ìƒìœ¼ë¡œ ì„¤ì •í•´ ì£¼ì„¸ìš” ">
      <span class="error" id="error-password1" style="color:red; font-size:0.9em;"></span><br>

      <label for="signup-password2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸:</label><br>
      <input type="password" id="signup-password2" name="password2" required>
      <span class="error" id="error-password2" style="color:red; font-size:0.9em;"></span><br>

      <button type="submit" style="padding:6px 12px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;">
        íšŒì›ê°€ì…
      </button>
    </form>
  </div>
</div>


    <!-- ë§ˆì´í˜ì´ì§€ ëª¨ë‹¬ -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('profileModal')">&times;</span>
    <h2>ë§ˆì´í˜ì´ì§€</h2>

    <form id="profileForm" method="POST" action="{% url 'accounts:update_profile' %}">
      {% csrf_token %}

      <label for="profile-username">ì•„ì´ë””:</label><br>
      <input type="text" id="profile-username" name="username" value="{{ user.username }}" disabled><br>

      <label for="profile-full_name">ì´ë¦„:</label><br>
      <input type="text" id="profile-full_name" name="full_name" value="{{ user.full_name }}" disabled><br>

      <label for="profile-phone_number">í•¸ë“œí° ë²ˆí˜¸:</label><br>
      <input type="text" id="profile-phone_number" name="phone_number" value="{{ user.phone_number }}" required>
      <span class="error" id="error-phone_number" style="color:red; font-size:0.9em;"></span><br>

      <label for="profile-car_number">ì°¨ëŸ‰ ë²ˆí˜¸:</label><br>
      <input type="text" id="profile-car_number" name="car_number" value="{{ user.car_number }}" required><br>

      <label for="profile-email">ì´ë©”ì¼:</label><br>
      <input type="email" id="profile-email" name="email" value="{{ user.email }}" required>
      <span class="error" id="profile-error-email" style="color:red; font-size:0.9em;"></span><br>

      <div id="profileMessages" style="margin-top:10px; color:red;"></div>
    </form>


    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
      <!-- ì •ë³´ ìˆ˜ì • ë²„íŠ¼ -->
      <button type="submit" form="profileForm"
              style="padding:6px 12px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;">
        ì •ë³´ ìˆ˜ì •
      </button>

      <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë²„íŠ¼ -->
      <button type="button" onclick="openModal('changePasswordModal')"
              style="padding:6px 12px; background:#ffc107; color:#fff; border:none; border-radius:4px; cursor:pointer;">
        ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
      </button>

      <!-- íšŒì› íƒˆí‡´ ë²„íŠ¼ -->
      <button type="submit" form="deleteForm"
              style="padding:6px 12px; background:#dc3545; color:#fff; border:none; border-radius:4px; cursor:pointer;">
        íšŒì› íƒˆí‡´
      </button>
    </div>

    <!-- íšŒì› íƒˆí‡´ form  -->
    <form id="deleteForm" method="POST" action="{% url 'accounts:delete_account' %}">
      {% csrf_token %}
    </form>
  </div>
</div>

 <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
<div id="changePasswordModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('changePasswordModal')">&times;</span>
    <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>

    <!-- ë©”ì‹œì§€ ì¶œë ¥ -->
    <ul id="passwordMessages" style="margin-bottom:10px;"></ul>

    <form id="passwordForm" method="POST" action="{% url 'accounts:change_password' %}">
      {% csrf_token %}
      <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸:</label><br>
      <input type="password" name="old_password" required><br>

      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸:</label><br>
      <input type="password" name="new_password1" required><br>

      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸:</label><br>
      <input type="password" name="new_password2" required><br>

      <button type="submit" style="padding:6px 12px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer; margin-top:10px;">
        ë³€ê²½
      </button>
    </form>
  </div>
</div>

 <!-- ì•„ì´ë”” ì°¾ê¸° ëª¨ë‹¬  -->
  <div id="findIdModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('findIdModal')">&times;</span>
    <h2>ì•„ì´ë”” ì°¾ê¸°</h2>
    <form id="findIdForm" method="POST" action="{% url 'accounts:find_id' %}">
      {% csrf_token %}
      <label for="find-name">ì´ë¦„:</label><br>
      <input type="text" id="find-name" name="name" required><br>

      <label for="find-email">ê°€ì… ì‹œ ì‚¬ìš©í•œ ì´ë©”ì¼:</label><br>
      <input type="email" id="find-email" name="email" required><br>

      <button type="submit">ì•„ì´ë”” ì°¾ê¸°</button>
    </form>
    <div id="findIdResult" style="margin-top:10px; color:blue;"></div>
  </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ëª¨ë‹¬ -->
<div id="resetModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('resetModal')">&times;</span>
    <h2>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h2>
    <form id="resetPasswordForm" method="POST" action="{% url 'accounts:reset_password_request' %}">
      {% csrf_token %}
      <label for="reset-email">ì´ë©”ì¼:</label><br>
      <input type="email" id="reset-email" name="email" required><br>
      <button type="submit" style="padding:6px 12px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer;">ë§í¬ ë°œì†¡</button>
    </form>
    <div id="reset-password-msg"></div>
  </div>
</div>





  <script>
  let map, carMarker = null, infoWindow = null;
  const parkingMarkers = [], roadLines = [];
  let parkingLots = [], trafficCameras = [];
  let currentCarLocation = null, currentVisibleLots = [];

  // ---------------- ì§€ë„ & ì£¼ì°¨ì¥ ë°ì´í„° ----------------
  async function loadParkingData() {
    try { const res = await fetch('/api/parking-lots/'); parkingLots = await res.json(); }
    catch { parkingLots = []; }
  }

  async function loadCameraData() {
    try { const res = await fetch('/api/traffic-cameras/'); trafficCameras = await res.json(); }
    catch { trafficCameras = []; }
  }

  window.onload = async () => {
    await loadParkingData();
    await loadCameraData();
    loadMap();
  };

  function loadMap() {
    kakao.maps.load(async () => {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.659434, 126.773379),
        level: 3
      });
      await loadRoadData();
      renderParkingList();
      document.getElementById('loadingOverlay').style.display = 'none';
    });
  }

  async function loadRoadData() {
    const url = `https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];relation(8125011);map_to_area->.searchArea;(way["highway"~"motorway|trunk|primary|secondary|tertiary|residential|unclassified|service"](area.searchArea););out geom;`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      data.elements.forEach(el => {
        if (el.type === 'way' && el.geometry) {
          const coords = el.geometry.map(p => [p.lon, p.lat]);
          roadLines.push(turf.lineString(coords));
        }
      });
    } catch {}
  }

  function renderParkingList(filteredLots = null) {
    const ul = document.getElementById('parkingUl');
    ul.innerHTML = '';
    const listToShow = filteredLots ?? parkingLots;
    currentVisibleLots = listToShow;
    handleSortChange();
  }

  function handleSortChange() {
    const sortType = document.getElementById('sortSelect').value;
    let sorted = [...currentVisibleLots];
    if (sortType === 'name') {
      sorted.sort((a,b) => a.name.localeCompare(b.name));
    } else if (sortType === 'distance' && currentCarLocation) {
      const carPt = turf.point([currentCarLocation[1], currentCarLocation[0]]);
      sorted.sort((a,b) => turf.distance(carPt, turf.point([a.longitude,a.latitude]), {units:'kilometers'}) -
                             turf.distance(carPt, turf.point([b.longitude,b.latitude]), {units:'kilometers'}));
    }
    const ul = document.getElementById('parkingUl');
    ul.innerHTML = '';
    if (!sorted.length) {
      const li = document.createElement('li');
      li.textContent = 'ì£¼ë³€ì— ì£¼ì°¨ì¥ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      li.style.color = '#888'; li.style.fontStyle='italic';
      ul.appendChild(li); return;
    }
    sorted.forEach(lot => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      let distanceText = '';
      if(sortType==='distance' && currentCarLocation){
        const carPt = turf.point([currentCarLocation[1], currentCarLocation[0]]);
        const lotPt = turf.point([lot.longitude, lot.latitude]);
        distanceText = ` (${Math.round(turf.distance(carPt, lotPt,{units:'kilometers'})*1000)}m)`;
      }
      a.textContent = lot.name + distanceText;
      a.href='#'; a.style.color='#007bff'; a.style.textDecoration='none'; a.style.display='block';
      a.addEventListener('mouseover', ()=>a.style.textDecoration='underline');
      a.addEventListener('mouseout', ()=>a.style.textDecoration='none');
      a.addEventListener('click', e=>{ e.preventDefault(); openParkingModal(lot); });
      li.appendChild(a); ul.appendChild(li);
    });
  }

  function openParkingModal(lot) {
    const modal = document.getElementById('parkingModal');
    const body = document.getElementById('parkingModalBody');
    body.innerHTML = `
      <h3>${lot.name}</h3>
      <p><strong>ì£¼ì†Œ:</strong> ${lot.road_address || lot.jibun_address || 'ì •ë³´ ì—†ìŒ'}</p>
      <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${lot.phone_number || 'ì •ë³´ ì—†ìŒ'}</p>
      <p><strong>ì´ ì£¼ì°¨ êµ¬íšìˆ˜:</strong> ${lot.capacity}</p>
      <div style="margin-top:15px; text-align:right;">
        <button onclick="goDetail(${JSON.stringify(lot.number)})"
                style="padding:6px 12px; background:#007bff; color:#fff;
                       border:none; border-radius:4px; cursor:pointer;">ìƒì„¸ì •ë³´ ë³´ê¸°</button>
      </div>
    `;
    modal.style.display='block';
  }

  function goDetail(number){ window.location.href = `/parking/${number}/`; }

  function openModal(modalId){ document.getElementById(modalId).style.display='block'; }
  function closeModal(modalId){ document.getElementById(modalId).style.display='none'; }

  function placeRandomOnRoad() {
    if(!roadLines.length){ alert('ë„ë¡œ ë°ì´í„°ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
    if(carMarker) carMarker.setMap(null);
    if(infoWindow) infoWindow.setMap(null);
    parkingMarkers.forEach(m=>m.setMap(null)); parkingMarkers.length=0;
    const line = roadLines[Math.floor(Math.random()*roadLines.length)];
    const dist = Math.random()*turf.length(line,{units:'kilometers'});
    const pt = turf.along(line, dist, {units:'kilometers'});
    const [lon,lat] = pt.geometry.coordinates;
    carMarker = new kakao.maps.Marker({map, position:new kakao.maps.LatLng(lat,lon)});
    map.setCenter(new kakao.maps.LatLng(lat,lon));
    currentCarLocation=[lat,lon];

    const illegal = isIllegalParkingArea(lat,lon);
    const msg = illegal ? "ğŸš« ë¶ˆë²• ì£¼ì •ì°¨ êµ¬ì—­ì…ë‹ˆë‹¤." : "âœ… ë¶ˆë²• ì£¼ì •ì°¨ êµ¬ì—­ì´ ì•„ë‹™ë‹ˆë‹¤.";
    infoWindow = new kakao.maps.CustomOverlay({
      content:`<div style="padding:12px;font-size:16px;font-weight:bold;min-width:220px;text-align:center;
               background:#fff;border:2px solid ${illegal?'#dc3545':'#28a745'};
               border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);
               color:${illegal?'#dc3545':'#28a745'}">${msg}</div>`,
      position:new kakao.maps.LatLng(lat,lon),
      yAnchor:1.8, zIndex:100
    }); infoWindow.setMap(map);

    if(illegal){ showNearbyParkingLots(lat,lon); const center = turf.point([lon,lat]);
      const nearby = parkingLots.filter(l=>turf.distance(center,turf.point([l.longitude,l.latitude]),{units:'kilometers'})<=1);
      renderParkingList(nearby);
    } else renderParkingList();
  }

  function isIllegalParkingArea(lat, lon){
    const pt = turf.point([lon,lat]);
    const nearCam = trafficCameras.some(c=>turf.distance(pt,turf.point([c.longitude,c.latitude]),{units:'kilometers'})<=0.1);
    const nearLot = parkingLots.some(l=>turf.distance(pt,turf.point([l.longitude,l.latitude]),{units:'kilometers'})<=0.05);
    return !(nearCam && nearLot) && nearCam;
  }

  function showNearbyParkingLots(lat, lon){
    parkingMarkers.forEach(m=>m.setMap(null)); parkingMarkers.length=0;
    const center = turf.point([lon,lat]);
    parkingLots.forEach(lot=>{
      if(turf.distance(center,turf.point([lot.longitude,lot.latitude]),{units:'kilometers'})<=1){
        const mk = new kakao.maps.Marker({ map, position:new kakao.maps.LatLng(lot.latitude,lot.longitude),
          image:new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
                                           new kakao.maps.Size(24,35),
                                           {offset:new kakao.maps.Point(12,35)})
        });
        const iw = new kakao.maps.InfoWindow({ content:`<div style="padding:5px;font-size:13px;">${lot.name}</div>` });
        kakao.maps.event.addListener(mk,'mouseover',()=>iw.open(map,mk));
        kakao.maps.event.addListener(mk,'mouseout',()=>iw.close());
        parkingMarkers.push(mk);
      }
    });
  }

  function clearMarkers(){
    if(carMarker) carMarker.setMap(null);
    parkingMarkers.forEach(m=>m.setMap(null)); parkingMarkers.length=0;
    renderParkingList();
    if(infoWindow){ infoWindow.close(); infoWindow=null; }
  }


      //-------- íšŒì› ê´€ë¦¬ --------


 function setupAjaxForm(formId, callback){
    const form = document.getElementById(formId);
    if(!form) return;
    form.addEventListener('submit', e=>{
        e.preventDefault();
        const formData = new FormData(form);
        const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch(form.action, {
            method:'POST', body:formData,
            headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrftoken}
        })
        .then(res=>res.json())
        .then(data=>callback(data))
        .catch(err=>console.error(err));
    });
}

// ---------------- íšŒì›ê°€ì… ----------------


setupAjaxForm('signupForm', data=>{
    document.querySelectorAll('.error').forEach(el=>el.textContent='');
    if(data.success){
        alert(data.message||'íšŒì›ê°€ì… ì™„ë£Œ!');
        setTimeout(()=>{ closeModal('signupModal'); closeModal('loginModal'); location.reload(); },500);
    } else {
        for(let field in data.errors){
            const el = document.getElementById(`error-${field}`);
            if(el) el.textContent = data.errors[field].join(', ');
        }
    }
});

// ---------------- ì•„ì´ë”” ì°¾ê¸° ----------------
setupAjaxForm('findIdForm', data => {
    const resultDiv = document.getElementById('findIdResult');
    const form = document.getElementById('findIdForm');
    resultDiv.innerHTML = '';

    if(data.success){
        resultDiv.innerHTML = `<div style="padding:12px;background:#e6f7ff;border:2px solid #1890ff;border-radius:8px;color:#004085;font-weight:bold;text-align:center;">ë‹¹ì‹ ì˜ ì•„ì´ë””ëŠ” <b>${data.usernames}</b> ì…ë‹ˆë‹¤.</div>`;
    } else {
        resultDiv.innerHTML = `<div style="padding:12px;background:#f8d7da;border:2px solid #f5c6cb;border-radius:8px;color:#721c24;font-weight:bold;text-align:center;">${data.message||'ì•„ì´ë””ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</div>`;
    }

    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë“±ë¡ (í•œ ë²ˆë§Œ)
    const modal = document.getElementById('findIdModal');
    if(modal && !modal._resetListenerAdded){
        const resetFn = () => {
            resultDiv.innerHTML = '';
            if(form) form.reset(); // ì…ë ¥ê°’ ì´ˆê¸°í™”
        };
        modal.addEventListener('click', e => { if(e.target === modal) resetFn(); });
        modal.querySelectorAll('.close').forEach(btn => btn.addEventListener('click', resetFn));
        modal._resetListenerAdded = true;
    }
});

// ---------------- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ----------------
setupAjaxForm('passwordForm', data => {
    const msgUl = document.getElementById('passwordMessages');
    const form = document.getElementById('passwordForm');

    // ë©”ì‹œì§€ ì´ˆê¸°í™”
    msgUl.innerHTML = '';

    if (data.success) {
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        const li = document.createElement('li');
        li.style.color = 'green';
        li.textContent = data.messages[0] || 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
        msgUl.appendChild(li);
    } else {
        // ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
        data.messages.forEach(msg => {
            const li = document.createElement('li');
            li.style.color = 'red';
            li.textContent = msg;
            msgUl.appendChild(li);
        });
    }

    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë“±ë¡ (í•œ ë²ˆë§Œ)
    const modal = document.getElementById('changePasswordModal');
    if (modal && !modal._resetListenerAdded) {
        const resetFn = () => {
            msgUl.innerHTML = '';
            if (form) form.reset(); // ì…ë ¥ê°’ ì´ˆê¸°í™”
            closeModal('changePasswordModal'); // ë‹«ê¸°
        };

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ
        modal.addEventListener('click', e => {
            if (e.target === modal) resetFn();
        });

        // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
        modal.querySelectorAll('.close').forEach(btn => btn.addEventListener('click', resetFn));

        modal._resetListenerAdded = true; // ì¤‘ë³µ ë“±ë¡ ë°©ì§€
    }
});

// ---------------- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ----------------
setupAjaxForm('resetPasswordForm', data => {
    const msgDiv = document.getElementById('reset-password-msg');
    const form = document.getElementById('resetPasswordForm');

    msgDiv.style.color = data.success ? 'green' : 'red';
    msgDiv.textContent = data.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë“±ë¡ (í•œ ë²ˆë§Œ)
    const modal = document.getElementById('resetModal');
    if(modal && !modal._resetListenerAdded){
        const resetFn = () => {
            msgDiv.textContent = '';
            if(form) form.reset(); // ì…ë ¥ê°’ ì´ˆê¸°í™”
        };
        modal.addEventListener('click', e => { if(e.target === modal) resetFn(); });
        modal.querySelectorAll('.close').forEach(btn => btn.addEventListener('click', resetFn));
        modal._resetListenerAdded = true;
    }
});


// ---------------- íšŒì›ì •ë³´ ìˆ˜ì • ----------------
setupAjaxForm('profileForm', data => {
    // ê¸°ì¡´ ì—ëŸ¬ ì´ˆê¸°í™”
    document.getElementById('profile-error-email').textContent = '';
    document.getElementById('error-phone_number').textContent = '';

    if(data.success){
        closeModal('profileModal');
        alert(data.message || 'íšŒì›ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
        // ì´ë©”ì¼ ì—ëŸ¬
        if(data.message && data.message.includes('ì´ë©”ì¼')){
            document.getElementById('profile-error-email').textContent = data.message;
        }
        // í•¸ë“œí° ì—ëŸ¬
        if(data.message && data.message.includes('í•¸ë“œí°')){
            document.getElementById('error-phone_number').textContent = data.message;
        }
    }
});

// ---------------- íšŒì› íƒˆí‡´ í™•ì¸ ----------------


const deleteForm = document.getElementById('deleteForm');
if(deleteForm){
    deleteForm.addEventListener('submit', e=>{
        if(!confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) e.preventDefault();
    });
}

// ---------------- ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ----------------


window.addEventListener('click', event=>{
    document.querySelectorAll('.modal').forEach(modal=>{
        if(event.target===modal) modal.style.display='none';
    });
});
document.querySelectorAll('.modal .close').forEach(btn=>{
    btn.addEventListener('click', function(){
        const modal = this.closest('.modal');
        if(modal) modal.style.display='none';
    });
});




  // ---------------- Django ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ ----------------


  window.addEventListener('DOMContentLoaded', ()=>{
    const boxes = document.querySelectorAll('#django-messages .message-box');
    boxes.forEach((box,idx)=>{
      setTimeout(()=>{ box.style.opacity=1; box.style.transform='translateY(0)'; }, 100*idx);
      setTimeout(()=>{ box.style.opacity=0; box.style.transform='translateY(-10px)'; setTimeout(()=>box.remove(),500); }, 3000+idx*100);
    });
  });

</script>
</body>
</html>
